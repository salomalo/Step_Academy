<?xml version="1.0" encoding="windows-1251" ?>

<!DOCTYPE page [
<!ENTITY nbsp "&#160;">
<!ENTITY пробел "&#160;">
<!ENTITY shy "&#173;">
<!ENTITY перенос "&#173;">
]>

<?xml:stylesheet type="text/xsl" href="../common/layout.xsl" ?>

<Урок xmlns="x-schema:Schema.xml" название="Создание резервных копий."  предыдущий="section03.xml" следующий="section05.xml" copyright="© 2005 Вадим Волянский, Алексей Туманов.">

<h1 style="color:maroon">Создание резервных копий.</h1>

<p>После проделанных проверок, создания устройств резервного копирования, пришло время для самого создания резервных копий.</p>

<p>Команда для резервного копирования:</p>

<pre style="border-color:#FF0000">
<br/>
	<b>BACKUP DATABASE</b> { имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных }

	TO имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN

	[ WITH 
	[ BLOCKSIZE = { размер_блока | @имя_переменной_хранящей_размер_блока } ]

	[ [ , ] DESCRIPTION = { 'комментарий' | @имя_переменной_хранящей_комментарий } ]

	[ [ , ] DIFFERENTIAL ]

	[ [ , ] EXPIREDATE = { дата | @имя_переменной_хранящей_дату }

	| RETAINDAYS = { дни| @имя_переменной_хранящей_дни } ]

	[ [ , ] PASSWORD = { пароль | @имя_переменной_хранящей_пароль } ]

	[ [ , ] FORMAT | NOFORMAT ]

	[ [ , ] { INIT | NOINIT } ]

	[ [ , ] MEDIADESCRIPTION = { 'доп_информация' | @имя_переменной_хранящей_доп_информацию } ]

	[ [ , ] MEDIANAME = { 'описательное_имя' | @имя_переменной_хранящей_описательное_имя } ]

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ]

	[ [ , ] NAME = { имя_резервной_копии | @имя_переменной_хранящей_имя_резервной_копии } ]

	[ [ , ] { NOSKIP | SKIP } ]

	[ [ , ] { NOREWIND | REWIND } ]

	[ [ , ] { NOUNLOAD | UNLOAD } ]

	[ [ , ] RESTART ]

	[ [ , ] STATS [ = проценты ] ]
]

</pre>

<ol>
	<li><b><i>Имя_базы_данных</i></b> - имя базы данных, для которой создается резервная копия. Может задаваться при помощи переменной.</li>
	<li><b><i>Перечисление устройств резервного копирования</i></b> - устройства, на которые будет производиться запись резервных копий. Они должны быть одного типа!!!</li>
	<li><b><i>размер_блока</i></b> - Размер блока, который выделяется на устройстве, при проведении резервного копирования через именованный канал, либо на магнитную ленту.</li>
	<li><b><i>комментарий</i></b> - Описание устройства резервного копирования. Максимальная длина 256 символов.</li>
	<li><b><i>DIFFERENTIAL</i></b> - Если уже есть созданная ранее резервная копия, то нет необходимости создавать ее заново. Существует возможность дифференцированного резервного копирования. Т.е. резервироваться будет только та часть, которая изменилась со времени предыдущего резервирования.</li>
	<li><b><i>EXPIREDATE</i></b> - Дата, до которой создаваемая резервная копия не может быть перезаписана.</li>
	<li><b><i>RETAINDAYS</i></b> - Кол-во дней, определяющее, сколько дней нельзя будет перезаписывать создаваемую резервную копию.</li>
	<li><b><i>PASSWORD</i></b> - Пароль для восстановления базы данных. Этот параметр защищает содержимое резервной копии от несанкционированного доступа, однако он не может предостеречь от ее перезаписи.</li>
	<li><b><i>FORMAT | NOFORMAT</i></b> - Определяет, нужно ли проводить форматирование магнитной ленты, перед записью на нее резервной копии (FORMAT), или этого делать не нужно (NOFORMAT). При форматировании будут потеряны все данные!!!</li>
	<li><b><i>INIT | NOINIT</i></b> - INIT определяет, что будет производиться перезапись резервной копии, если срок действия резервной копии истек. NOINIT - указывает на то, что на указанном устройстве резервного копирования уже есть резервная копия с таким же именем, как и добавляетмая. При этом перезапись производиться не будет, а создаваемая резервная копия будет добавлена после существующей на устройстве. Если же на устройстве нет такой резервной копии, то будет использована обычная процедура записи.</li>
	<li><b><i>MEDIADESCRIPTION</i></b> - Дополнительная информация. Длина строки не может превышать 255 символов.</li>
	<li><b><i>MEDIANAME</i></b> - Здесь указывается имя, описывающее набор резервных копий.  Длина строки не может превышать 128 символов.</li>
	<li><b><i>MEDIAPASSWORD</i></b> - Это пароль, который защищает резервную копию в наборе. Если указан этот пароль, то перезаписать его, не указав пароль нельзя. Однако, он не защищает от форматирования. Этот пароль необходимо будет указывать для восстановления базы данных.</li>
	<li><b><i>NAME</i></b> - имя набора резервных копий. Максимальная длина 128 символов.</li>
	<li><b><i>NOSKIP | SKIP</i></b> SKIP определяет пропуск ANSI заголовков. SQL Server будет игнорировать любые существующие ANSI этикетки на ленточном устройстве. Этикетки ANSI могут предоставлять важную информацию о дате окончания действия ленты, а также ускоряют разрешения записи. Если нужно читать ANSI этикетки ленты, то для этого используется NOSKIP. Сервер SQL будет проверять дату окончания действия и имя всех наборов резервирования на устройстве, прежде чем позволит перезаписать их. Эта опция установлена по умолчанию.</li>
	<li><b><i>NOREWIND | REWIND</i></b> - Определяется, производить ли перематывание пленки после окончания резервного копирования.</li>
	<li><b><i>NOUNLOAD | UNLOAD</i></b> - Определяется, можно ли вынуть ленту после окончания резервного копирования.</li>
	<li><b><i>RESTART</i></b> - Эта опция определяет, что процесс резервного копирования будет продолжен в случае приостановки процесса. Возможно продолжение создания резервной копии только в том случае, если используется несколько устройств резервного копирования.</li>
	<li><b><i>STATS</i></b> - В процентах указывается  частота уведомления о прогрессе резервного копирования. По умолчанию установлено значение 10%.</li>
</ol>

<p>Пару примеров:</p>

<pre style="border-color:863900">

1.	BACKUP DATABASE books TO mybackup WITH INIT <span style="color:#008080">/*Полное резервное копирование.*/</span>

2.	BACKUP DATABASE pubs TO disk=’c:\mybackup.bak’ WITH INIT <span style="color:#008080">/*Полное резервное копирование.*/</span>

3.	BACKUP DATABASE pubs TO mybackup WITH DIFFERENTIAL NOINIT <span style="color:#008080">/*Распределенное резервное копирование.*/</span>

4.	BACKUP LOG pubs TO PUBS_LOG <span style="color:#008080">/*Создание резервное копии журнала транзакций.*/</span>

</pre>

<p>Общий синтаксис резервного копирования набора файлов, либо группы файлов следующий:</p>

<pre style="border-color:#FF0000">
<b>BACKUP DATABASE</b> { имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных }

	[ FILE = Логическое_имя_файла | FILEGROUP = Логическое имя_группы_файлов, [,...n] ]

	TO имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN

	[ WITH 
	[ BLOCKSIZE = { размер_блока | @имя_переменной_хранящей_размер_блока } ]

	[ [ , ] DESCRIPTION = { 'комментарий' | @имя_переменной_хранящей_комментарий } ]

	[ [ , ] DIFFERENTIAL ]

	[ [ , ] EXPIREDATE = { дата | @имя_переменной_хранящей_дату }

	| RETAINDAYS = { дни| @имя_переменной_хранящей_дни } ]

	[ [ , ] PASSWORD = { пароль | @имя_переменной_хранящей_пароль } ]

	[ [ , ] FORMAT | NOFORMAT ]

	[ [ , ] { INIT | NOINIT } ]

	[ [ , ] MEDIADESCRIPTION = { 'доп_информация' | @имя_переменной_хранящей_доп_информацию } ]

	[ [ , ] MEDIANAME = { 'описательное_имя' | @имя_переменной_хранящей_описательное_имя } ]

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ]

	[ [ , ] NAME = { имя_резервной_копии | @имя_переменной_хранящей_имя_резервной_копии } ]

	[ [ , ] { NOSKIP | SKIP } ]

	[ [ , ] { NOREWIND | REWIND } ]

	[ [ , ] { NOUNLOAD | UNLOAD } ]

	[ [ , ] RESTART ]

	[ [ , ] STATS [ = проценты ] ]

</pre>

<p>Пример:</p>

<pre style="border-color:863900">

	BACKUP DATABASE library

	FILE = File1 TO File1Backup 

</pre>

<p>Команда Backup Log создает резервную копию журнала транзакций.</p>

<pre style="border-color:#FF0000">
<b>BACKUP LOG</b> { имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных }

	TO имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN

	[ WITH 
	[ BLOCKSIZE = { размер_блока | @имя_переменной_хранящей_размер_блока } ]

	[ [ , ] DESCRIPTION = { 'комментарий' | @имя_переменной_хранящей_комментарий } ]

	[ [ , ] EXPIREDATE = { дата | @имя_переменной_хранящей_дату }

	| RETAINDAYS = { дни| @имя_переменной_хранящей_дни } ]

	[ [ , ] PASSWORD = { пароль | @имя_переменной_хранящей_пароль } ]

	[ [ , ] FORMAT | NOFORMAT ]

	[ [ , ] { INIT | NOINIT } ]

	[ [ , ] MEDIADESCRIPTION = { 'доп_информация' | @имя_переменной_хранящей_доп_информацию } ]

	[ [ , ] MEDIANAME = { 'описательное_имя' | @имя_переменной_хранящей_описательное_имя } ]

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ]

	[ [ , ] NAME = { имя_резервной_копии | @имя_переменной_хранящей_имя_резервной_копии } ]

	 [ [ , ] NO_TRUNCATE ] 

	[ [ , ] { NORECOVERY | STANDBY = undo_file_name } ]

	[ [ , ] { NOSKIP | SKIP } ]

	[ [ , ] { NOREWIND | REWIND } ]

	[ [ , ] { NOUNLOAD | UNLOAD } ]

	[ [ , ] RESTART ]

	[ [ , ] STATS [ = проценты ] ]

</pre>

<p>При использовании команды backup log можно не создавать резервную копию, а произвести обрезание неактивной части журнала транзакций.</p>

<pre style="border-color:#FF0000">
<b>BACKUP LOG</b> { имя_базы_данных | @имя_переменной_хранящей_имя_базы_данных }

	[ WITH { NO_LOG | TRUNCATE_ONLY } ] 
</pre>

<p><b><i>NO_LOG | TRUNCATE_ONLY</i></b> - Эти опции эквивалентны и говорят о том, что неактивная часть журнала должна быть урезана. Обычно данная команда указывается тогда, когда не планируется восстановление по журналу транзакций. По умолчанию стоит опция  NO_TRUNCATE</p>

<p>Бывают ситуации, когда файл базы данных разрушен или потерян, а журнал транзакций находится, например, на другом диске. Тогда существует возможность полную резервную копию журнала транзакций, указав опцию NO_TRUNCATE. При восстановлении базы данных,  существует возможность восстановить базу данных из резервной копии до начальной версии и сделать сохраненные в журнале команды, для приведения базы данных до момента сбоя.</p>

<p>Пример обрезания журнала транзакций.:</p>

<pre style="border-color:863900">

	BACKUP LOG books WITH NO_LOG 

</pre>

<p><b>ВНИМАНИЕ!!!</b> Сделать BACKUP LOG можно либо если производилось распределенное резервное копирование базы данных, либо если вручную указать режим восстановления. Для этого необходимо воспользоваться хранимой процедурой:</p>

<pre style="border-color:#FF0000">

	Alter database имя_базы_данных

	Set Recovery {FULL | SIMPLE | BULK_LOGGED}

</pre>

<h3 style="color:#05027E;text-align:center">Схема резервного копирования базы данных через Enterprise Manager.</h3>

<p>Для создания резервной копии определенной базы данных нужно выбрать в контекстном меню к папке Backup Devices сервера пункт Back Up a Database.</p>

<img src="img\pict6.jpg"></img>

<p>В следующем окне вы можете настроить все что вам может понадобиться при резервировании баз данных.</p>

<img src="img\pict7.jpg"></img>

<ol>
	<li>Database - имя базы данных, для которой создается резервная копия.</li>
	<li>Name - имя резервной копии.</li>
	<li>Description - описание резервной копии.</li>
	<li>Опции Backup type определяют вид резервного копирования</li>
	<ul>
		<li>Full - полное резервное копирование.</li>
		<li>Differential - дифференцированное резервное копирование.</li>
		<li>Transaction log - резервное копирование журнала транзакций.</li>
		
	</ul>
	<li>Опции Backup component определяют, что подвергается резервному копированию база данных или набор(группа) файлов</li>
	<li>Опции Destination определяют устройства резервного копирования.</li>
	
	<ul>
		<li>Tape | Disk - определяют тип устройства носителя.</li>
		<li>Add - добавление устройства.</li>
		<li>Remove - удаление устройства из списка.</li>
	</ul>
	</ol>
	<p>Кликнем по вкладке Options</p>
	<img src="img\pict71.jpg"></img>
	<ol>
	<li>Опции Overwrite media:</li>
	<ul>
		<li>Append to the existing backup set - произвести добавление резервной копии.</li>
		<li>Overwite all existing media backup sets- произвести перезапись существующей копии.</li>
	</ul>
	
</ol>
<p>
Об остальных настройках резервного копирования можно прочитать в Books online.</p>
</Урок>