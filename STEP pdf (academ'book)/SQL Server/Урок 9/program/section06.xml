<?xml version="1.0" encoding="windows-1251" ?>

<!DOCTYPE page [
<!ENTITY nbsp "&#160;">
<!ENTITY пробел "&#160;">
<!ENTITY shy "&#173;">
<!ENTITY перенос "&#173;">
]>

<?xml:stylesheet type="text/xsl" href="../common/layout.xsl" ?>

<Урок xmlns="x-schema:Schema.xml" название="Виды восстановлений:"  предыдущий="section05.xml" следующий="section07.xml" copyright="© 2005 Вадим Волянский, Алексей Туманов.">

<h1 style="color:maroon">Виды восстановлений:</h1>

<p>Существует 2 вида восстановления:</p>

<ol>
	<li>Автоматическое восстановление.</li>
	<li>Ручное восстановление.</li>
</ol>

<h3 style="color:#05027E;text-align:center">Автоматическое восстановление.</h3>

<p>Автоматическое восстановление базы данных производится каждый раз при старте SQL Server. При этом есть определенный сценарий того, как это происходит. Вот порядок действий, которые выполняются:</p>

<ol>
	<li>При запуске сервер отыскивает в реестре путь к БД master.</li>
	<li>После того, как база данных master найдена, она загружается и восстанавливается на основании журнала транзакций, из которого берутся все команды, идущие после последней контрольной точки. После этого, просматривается содержимое системной таблицы sysdatabases, из которой SQL Server получает первичные данные обо всех базах данных. После этого SQL Server переходить к восстановлению остальных баз данных. Сведения о файлах баз данных хранятся в системных таблицах sysfiles и sysfilegroups.</li>
	<li>Следующим этапом восстанавливается база данных model.</li>
	<li>Следующим шагом пересоздается tempdb.</li>
	<li>Потом msdb.</li>
	<li>Затем pubs.</li>
	<li>После northwind.</li>
	<li>А затем все остальные пользовательские базы данных.</li>
</ol>

<p>При автоматическом восстановлении можно настроить время, которое будет максимально затрачено на этот процесс. Для этого нужно воспользоваться хранимой процедурой sp_configure.</p>

<pre style="border-color:#FF0000">

	Execute <b>sp_configure</b>

	[ [ <b><i>@configname</i></b> = ] 'имя_опции' ] 

	[ , [ <b><i>@configvalue</i></b> = ] 'значение' ]

</pre>

<p>Нам нужна опция, которая называется Recovery Interval. Значение для нее задается в минутах и определяет максимальный интервал времени, который выделяется серверу на автоматическое восстановление. Также эта величина определяет частоту установки контрольных точек.</p>

<p>Чтобы произведенные изменения вступили в силу, нужно воспользоваться коммандой RECONFIGURE с параметром WITH OVERRIDE, позволяющей указать серверу, что не нужно проводить проверку правильности измененных значений.</p>

<p>Пример:</p>

<pre style="border-color:863900">

	Use master

	Execute sp_configure 'recovery interval', '3'

	RECONFIGURE WITH OVERRIDE

</pre>

<p>При выполнении автоматического восстановления, информация заносится внутрь журнала ошибок и сообщений, котроый находится в папке <b>C:\Program Files\Microsoft SQL Server\MSSQL\LOG</b>.</p>

<h3 style="color:#05027E;text-align:center">Ручное восстановление.</h3>

<p>Именно этот процесс является, хоть и более сложным, но более эффективным, т.к. позволяет четко настроить что конкретно и откуда нужно восстанавливать.</p>

<p>При ручном восстановлении необходимо соблюдать ряд правил:</p>

<ol>
	<li>Восстанавливаемую базу данных никто не должен использовать.</li>
	<li>Вы должны иметь право производить восстановление. На это имеют право пользователи ролей sysadmin и db_creator, а также dbo.</li>
	<li>Прежде чем приступить к собственно восстановлению, нужно проверить состояние и информацию об устройствах резервного копирования.</li>
</ol>

<p>Чтобы получить информацию об определенном устройстве резервирования, необходимо воспользоваться командой <b>RESTORE LABELONLY</b>.</p>

<pre style="border-color:#FF0000">

	<b>RESTORE LABELONLY</b>

	FROM имя_устройства_резервного_копирования

	[ WITH { NOUNLOAD | UNLOAD } ]

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ] 

	имя_устройтсва_резервного_копирования  ::= 

	{ 
		{ 'логическое_имя_устройства_резервирования' | 
		имя_переменной_хранящей_логическиое_имя_устройства_резервирования }

		| { DISK | TAPE } = 
		{ 'физическое_имя_устройства_резервирования'|
		@имя_переменной_хранящей_физическое_имя_устройства_резервирования } 
	}

</pre>

<p>Эта команда вернет информацию о настройках набора резервных копий (например, о дате образования резервной копии).</p>

<p>Пример команды, выводящей на экран информацию о всем наборе резервных копиях. При этом резервная копия, либо набор резервных копий, должен быть сохранен на устройстве.</p>

<pre style="border-color:863900">

	RESTORE LABELONLY FROM MyBackup

</pre>

<p>Чтобы получить более расшеренную информацию о каждой резервной копии в отдельной строке используется команда <b>RESTORE HEADERONLY</b>.</p>

<pre style="border-color:#FF0000">

	<b>RESTORE HEADERONLY</b>

	FROM имя_устройства_резервного_копирования
 
	[ WITH { NOUNLOAD | UNLOAD } 

	[ [ , ] FILE = номер_набора_резервных_копий_на_магнитной_ленте ]

	[ [ , ] PASSWORD = { пароль | @имя_переменной_хранящей_пароль } ] 

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ] 
	] 

</pre>

<p>Эта команда выведет имя пользователя, создавшего резервную копию, название базы данных, ее размер и пр.</p>

<p>Иногда нужно получить список файлов данных и журналов транзакций, резервные копии которых хранятся на определенном устройстве резервирования. Для этого служит команда <b>RESTORE FILELISTONLY</b>.</p>

<pre style="border-color:#FF0000">

	<b>RESTORE FILELISTONLY</b>

	FROM имя_устройства_резервного_копирования
 
	[ WITH

	[ FILE = номер_набора_резервных_копий_на_магнитной_ленте ]

	[ [ , ] PASSWORD = { пароль | @имя_переменной_хранящей_пароль } ] 

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ] 

	[ [ , ] { NOUNLOAD | UNLOAD }
	] 

	имя_устройтсва_резервного_копирования  ::= 

	{ 
		{ 'логическое_имя_устройства_резервирования' | 
		имя_переменной_хранящей_логическиое_имя_устройства_резервирования }

		| { DISK | TAPE } = 
		{ 'физическое_имя_устройства_резервирования'|
		@имя_переменной_хранящей_физическое_имя_устройства_резервирования } 
	}

</pre>

<p>А для проверки устройства резервного копирования используется команда <b>RESTORE VERIFYONLY</b>. В частности, будет производиться проверка данных на считываемость.</p>

<pre style="border-color:#FF0000">

	<b>RESTORE VERIFYONLY</b>

	FROM имя_устройства_резервного_копирования1,

	имя_устройства_резервного_копирования2,

	...

	имя_устройства_резервного_копированияN

	[ WITH 

	[ FILE = номер_набора_резервных_копий_на_магнитной_ленте ] 

	[ [ , ] { NOUNLOAD | UNLOAD } ] 

	[ [ , ] LOADHISTORY ] 

	[ [ , ] PASSWORD = { пароль | @имя_переменной_хранящей_пароль } ] 

	[ [ , ] MEDIAPASSWORD = { 'пароль_на_восстановление' | @имя_переменной_хранящей_пароль_на_восстановление } ] 

	[ [ , ] { NOREWIND | REWIND } ]
	] 

	имя_устройтсва_резервного_копирования  ::= 

	{ 
		{ 'логическое_имя_устройства_резервирования' | 
		имя_переменной_хранящей_логическиое_имя_устройства_резервирования }

		| { DISK | TAPE } = 
		{ 'физическое_имя_устройства_резервирования'|
		@имя_переменной_хранящей_физическое_имя_устройства_резервирования } 
	}

</pre>

<p><b>Эта команда проверяет устройство резервного копирования, но не производит восстановление!!!</b></p>

</Урок>